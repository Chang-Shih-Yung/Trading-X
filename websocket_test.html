<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket 信號測試頁面</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message {
      background-color: #e2e3e5;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    .signal {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .signal-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🎯 WebSocket 信號測試頁面</h1>

    <div id="connectionStatus" class="status disconnected">
      ❌ 未連接到 WebSocket
    </div>

    <div>
      <button id="connectBtn" onclick="connectWebSocket()">連接 WebSocket</button>
      <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>斷開連接</button>
      <button id="triggerBtn" onclick="triggerTestSignal()">觸發測試信號</button>
      <button id="clearBtn" onclick="clearMessages()">清除消息</button>
    </div>

    <h3>📡 收到的信號 (共 <span id="signalCount">0</span> 個)</h3>
    <div id="signalList" class="signal-list"></div>

    <h3>📨 所有消息 (共 <span id="messageCount">0</span> 個)</h3>
    <div id="messageList" class="signal-list"></div>
  </div>

  <script>
    let websocket = null;
    let messageCount = 0;
    let signalCount = 0;

    function updateStatus(message, isConnected) {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.textContent = message;
      statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;

      document.getElementById('connectBtn').disabled = isConnected;
      document.getElementById('disconnectBtn').disabled = !isConnected;
    }

    function addMessage(message, isSignal = false) {
      messageCount++;
      document.getElementById('messageCount').textContent = messageCount;

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isSignal ? 'signal' : ''}`;
      messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;

      const messageList = document.getElementById('messageList');
      messageList.insertBefore(messageDiv, messageList.firstChild);
    }

    function addSignal(signalData) {
      signalCount++;
      document.getElementById('signalCount').textContent = signalCount;

      const signalDiv = document.createElement('div');
      signalDiv.className = 'message signal';
      signalDiv.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}] 🎯 交易信號 #${signalCount}</strong><br>
                • 交易對: ${signalData.symbol}<br>
                • 信號類型: ${signalData.signal_type}<br>
                • 信心度: ${signalData.confidence}<br>
                • 進場價: ${signalData.entry_price}<br>
                • 止損價: ${signalData.stop_loss}<br>
                • 止盈價: ${signalData.take_profit}<br>
                • 推理: ${signalData.reasoning}<br>
                • 時間框架: ${signalData.timeframe}
            `;

      const signalList = document.getElementById('signalList');
      signalList.insertBefore(signalDiv, signalList.firstChild);
    }

    function connectWebSocket() {
      const wsUrl = 'ws://localhost:8000/api/v1/realtime/ws';

      try {
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function () {
          updateStatus('✅ WebSocket 連接成功', true);
          addMessage('🔌 WebSocket 連接建立');

          // 發送訂閱消息
          const subscribeMessage = {
            action: "subscribe",
            symbols: ["BTCUSDT", "ETHUSDT", "BNBUSDT"],
            data_types: ["trading_signals", "prices", "market_updates"]
          };

          websocket.send(JSON.stringify(subscribeMessage));
          addMessage('📡 已發送訂閱消息: ' + JSON.stringify(subscribeMessage));
        };

        websocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            const messageType = data.type || 'unknown';

            if (messageType === 'trading_signal') {
              addMessage(`🎯 收到交易信號: ${data.data.symbol} ${data.data.signal_type}`, true);
              addSignal(data.data);
            } else if (messageType === 'connection_established') {
              addMessage('✅ 連接確認: ' + data.message);
            } else if (messageType === 'subscription_confirmed') {
              addMessage('📡 訂閱確認: ' + JSON.stringify(data.symbols));
            } else if (messageType === 'price_update') {
              addMessage(`💰 價格更新: ${data.symbol} = ${data.data.price}`);
            } else if (messageType === 'price_batch_update') {
              const prices = data.data?.prices || {};
              addMessage(`💰 批量價格更新: ${Object.keys(prices).length} 個交易對`);
            } else if (messageType === 'heartbeat') {
              addMessage('💓 心跳包');
            } else {
              addMessage('📨 其他消息: ' + messageType + ' - ' + JSON.stringify(data));
            }
          } catch (error) {
            addMessage('❌ 解析消息失敗: ' + event.data);
          }
        };

        websocket.onclose = function (event) {
          updateStatus('❌ WebSocket 連接關閉', false);
          addMessage(`🔌 連接關閉: ${event.code} - ${event.reason}`);
        };

        websocket.onerror = function (error) {
          updateStatus('❌ WebSocket 連接錯誤', false);
          addMessage('❌ 連接錯誤: ' + error);
        };

      } catch (error) {
        updateStatus('❌ 無法建立 WebSocket 連接', false);
        addMessage('❌ 連接失敗: ' + error);
      }
    }

    function disconnectWebSocket() {
      if (websocket) {
        websocket.close();
        websocket = null;
      }
    }

    function triggerTestSignal() {
      fetch('http://localhost:8000/api/v1/realtime-signals/signals/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            addMessage('🚀 測試信號觸發成功: ' + data.message);
          } else {
            addMessage('❌ 測試信號觸發失敗: ' + data.message);
          }
        })
        .catch(error => {
          addMessage('❌ 觸發測試信號時出錯: ' + error);
        });
    }

    function clearMessages() {
      document.getElementById('messageList').innerHTML = '';
      document.getElementById('signalList').innerHTML = '';
      messageCount = 0;
      signalCount = 0;
      document.getElementById('messageCount').textContent = messageCount;
      document.getElementById('signalCount').textContent = signalCount;
    }

    // 頁面加載時自動連接
    window.onload = function () {
      addMessage('🚀 頁面加載完成，點擊"連接 WebSocket"開始測試');
    };
  </script>
</body>

</html>