<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket ä¿¡è™Ÿæ¸¬è©¦é é¢</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    .connected {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message {
      background-color: #e2e3e5;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    .signal {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .signal-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ¯ WebSocket ä¿¡è™Ÿæ¸¬è©¦é é¢</h1>

    <div id="connectionStatus" class="status disconnected">
      âŒ æœªé€£æ¥åˆ° WebSocket
    </div>

    <div>
      <button id="connectBtn" onclick="connectWebSocket()">é€£æ¥ WebSocket</button>
      <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>æ–·é–‹é€£æ¥</button>
      <button id="triggerBtn" onclick="triggerTestSignal()">è§¸ç™¼æ¸¬è©¦ä¿¡è™Ÿ</button>
      <button id="clearBtn" onclick="clearMessages()">æ¸…é™¤æ¶ˆæ¯</button>
    </div>

    <h3>ğŸ“¡ æ”¶åˆ°çš„ä¿¡è™Ÿ (å…± <span id="signalCount">0</span> å€‹)</h3>
    <div id="signalList" class="signal-list"></div>

    <h3>ğŸ“¨ æ‰€æœ‰æ¶ˆæ¯ (å…± <span id="messageCount">0</span> å€‹)</h3>
    <div id="messageList" class="signal-list"></div>
  </div>

  <script>
    let websocket = null;
    let messageCount = 0;
    let signalCount = 0;

    function updateStatus(message, isConnected) {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.textContent = message;
      statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;

      document.getElementById('connectBtn').disabled = isConnected;
      document.getElementById('disconnectBtn').disabled = !isConnected;
    }

    function addMessage(message, isSignal = false) {
      messageCount++;
      document.getElementById('messageCount').textContent = messageCount;

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isSignal ? 'signal' : ''}`;
      messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;

      const messageList = document.getElementById('messageList');
      messageList.insertBefore(messageDiv, messageList.firstChild);
    }

    function addSignal(signalData) {
      signalCount++;
      document.getElementById('signalCount').textContent = signalCount;

      const signalDiv = document.createElement('div');
      signalDiv.className = 'message signal';
      signalDiv.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}] ğŸ¯ äº¤æ˜“ä¿¡è™Ÿ #${signalCount}</strong><br>
                â€¢ äº¤æ˜“å°: ${signalData.symbol}<br>
                â€¢ ä¿¡è™Ÿé¡å‹: ${signalData.signal_type}<br>
                â€¢ ä¿¡å¿ƒåº¦: ${signalData.confidence}<br>
                â€¢ é€²å ´åƒ¹: ${signalData.entry_price}<br>
                â€¢ æ­¢æåƒ¹: ${signalData.stop_loss}<br>
                â€¢ æ­¢ç›ˆåƒ¹: ${signalData.take_profit}<br>
                â€¢ æ¨ç†: ${signalData.reasoning}<br>
                â€¢ æ™‚é–“æ¡†æ¶: ${signalData.timeframe}
            `;

      const signalList = document.getElementById('signalList');
      signalList.insertBefore(signalDiv, signalList.firstChild);
    }

    function connectWebSocket() {
      const wsUrl = 'ws://localhost:8000/api/v1/realtime/ws';

      try {
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function () {
          updateStatus('âœ… WebSocket é€£æ¥æˆåŠŸ', true);
          addMessage('ğŸ”Œ WebSocket é€£æ¥å»ºç«‹');

          // ç™¼é€è¨‚é–±æ¶ˆæ¯
          const subscribeMessage = {
            action: "subscribe",
            symbols: ["BTCUSDT", "ETHUSDT", "BNBUSDT"],
            data_types: ["trading_signals", "prices", "market_updates"]
          };

          websocket.send(JSON.stringify(subscribeMessage));
          addMessage('ğŸ“¡ å·²ç™¼é€è¨‚é–±æ¶ˆæ¯: ' + JSON.stringify(subscribeMessage));
        };

        websocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            const messageType = data.type || 'unknown';

            if (messageType === 'trading_signal') {
              addMessage(`ğŸ¯ æ”¶åˆ°äº¤æ˜“ä¿¡è™Ÿ: ${data.data.symbol} ${data.data.signal_type}`, true);
              addSignal(data.data);
            } else if (messageType === 'connection_established') {
              addMessage('âœ… é€£æ¥ç¢ºèª: ' + data.message);
            } else if (messageType === 'subscription_confirmed') {
              addMessage('ğŸ“¡ è¨‚é–±ç¢ºèª: ' + JSON.stringify(data.symbols));
            } else if (messageType === 'price_update') {
              addMessage(`ğŸ’° åƒ¹æ ¼æ›´æ–°: ${data.symbol} = ${data.data.price}`);
            } else if (messageType === 'price_batch_update') {
              const prices = data.data?.prices || {};
              addMessage(`ğŸ’° æ‰¹é‡åƒ¹æ ¼æ›´æ–°: ${Object.keys(prices).length} å€‹äº¤æ˜“å°`);
            } else if (messageType === 'heartbeat') {
              addMessage('ğŸ’“ å¿ƒè·³åŒ…');
            } else {
              addMessage('ğŸ“¨ å…¶ä»–æ¶ˆæ¯: ' + messageType + ' - ' + JSON.stringify(data));
            }
          } catch (error) {
            addMessage('âŒ è§£ææ¶ˆæ¯å¤±æ•—: ' + event.data);
          }
        };

        websocket.onclose = function (event) {
          updateStatus('âŒ WebSocket é€£æ¥é—œé–‰', false);
          addMessage(`ğŸ”Œ é€£æ¥é—œé–‰: ${event.code} - ${event.reason}`);
        };

        websocket.onerror = function (error) {
          updateStatus('âŒ WebSocket é€£æ¥éŒ¯èª¤', false);
          addMessage('âŒ é€£æ¥éŒ¯èª¤: ' + error);
        };

      } catch (error) {
        updateStatus('âŒ ç„¡æ³•å»ºç«‹ WebSocket é€£æ¥', false);
        addMessage('âŒ é€£æ¥å¤±æ•—: ' + error);
      }
    }

    function disconnectWebSocket() {
      if (websocket) {
        websocket.close();
        websocket = null;
      }
    }

    function triggerTestSignal() {
      fetch('http://localhost:8000/api/v1/realtime-signals/signals/test', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            addMessage('ğŸš€ æ¸¬è©¦ä¿¡è™Ÿè§¸ç™¼æˆåŠŸ: ' + data.message);
          } else {
            addMessage('âŒ æ¸¬è©¦ä¿¡è™Ÿè§¸ç™¼å¤±æ•—: ' + data.message);
          }
        })
        .catch(error => {
          addMessage('âŒ è§¸ç™¼æ¸¬è©¦ä¿¡è™Ÿæ™‚å‡ºéŒ¯: ' + error);
        });
    }

    function clearMessages() {
      document.getElementById('messageList').innerHTML = '';
      document.getElementById('signalList').innerHTML = '';
      messageCount = 0;
      signalCount = 0;
      document.getElementById('messageCount').textContent = messageCount;
      document.getElementById('signalCount').textContent = signalCount;
    }

    // é é¢åŠ è¼‰æ™‚è‡ªå‹•é€£æ¥
    window.onload = function () {
      addMessage('ğŸš€ é é¢åŠ è¼‰å®Œæˆï¼Œé»æ“Š"é€£æ¥ WebSocket"é–‹å§‹æ¸¬è©¦');
    };
  </script>
</body>

</html>