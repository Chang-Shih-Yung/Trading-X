<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎯 狙擊手歷史數據測試</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .signal-card {
      border: 1px solid #ddd;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .signal-card.expired {
      border-color: #ff6b6b;
      background: #ffe0e0;
    }

    .signal-header {
      font-weight: bold;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .signal-details {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status.expired {
      background: #ff6b6b;
      color: white;
    }

    .status.active {
      background: #51cf66;
      color: white;
    }

    button {
      background: #4c6ef5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #364fc7;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .error {
      background: #ffe0e0;
      color: #c92a2a;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .success {
      background: #d3f9d8;
      color: #2b8a3e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>🎯 狙擊手歷史數據測試頁面</h1>
      <p>測試基於智能時間分層動態計算的真實過期信號</p>
    </div>

    <div class="controls">
      <button onclick="fetchActiveSignals()">獲取活躍信號</button>
      <button onclick="fetchExpiredSignals()">獲取過期信號</button>
      <button onclick="triggerExpiration()">手動觸發過期處理</button>
      <button onclick="checkSchedulerStatus()">檢查調度器狀態</button>
    </div>

    <div id="status"></div>
    <div id="activeSignals"></div>
    <div id="expiredSignals"></div>
    <div id="schedulerInfo"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8000/api/v1/scalping';

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => statusDiv.innerHTML = '', 5000);
    }

    async function fetchActiveSignals() {
      try {
        showStatus('🔄 獲取活躍信號中...', 'loading');
        const response = await fetch(`${API_BASE}/dashboard-precision-signals`);
        const data = await response.json();

        const container = document.getElementById('activeSignals');
        container.innerHTML = '<h2>🎯 活躍狙擊手信號</h2>';

        if (data.signals && data.signals.length > 0) {
          data.signals.forEach(signal => {
            const card = createSignalCard(signal, 'active');
            container.appendChild(card);
          });
          showStatus(`✅ 獲取到 ${data.signals.length} 個活躍信號`, 'success');
        } else {
          container.innerHTML += '<p>暫無活躍信號</p>';
          showStatus('ℹ️ 暫無活躍信號', 'info');
        }
      } catch (error) {
        showStatus(`❌ 獲取活躍信號失敗: ${error.message}`, 'error');
      }
    }

    async function fetchExpiredSignals() {
      try {
        showStatus('🔄 獲取過期信號中...', 'loading');
        const response = await fetch(`${API_BASE}/expired`);
        const data = await response.json();

        const container = document.getElementById('expiredSignals');
        container.innerHTML = '<h2>📜 過期狙擊手信號 (歷史數據)</h2>';

        let signals = [];
        if (data.signals) {
          signals = data.signals;
        } else if (Array.isArray(data)) {
          signals = data;
        }

        if (signals.length > 0) {
          signals.forEach(signal => {
            const card = createSignalCard(signal, 'expired');
            container.appendChild(card);
          });
          showStatus(`✅ 獲取到 ${signals.length} 個過期信號 (數據源: ${data.data_source || 'unknown'})`, 'success');
        } else {
          container.innerHTML += '<p>❌ 暫無過期信號 - 這表示歷史數據為空！</p>';
          showStatus('⚠️ 歷史數據為空！需要真實的過期信號', 'error');
        }
      } catch (error) {
        showStatus(`❌ 獲取過期信號失敗: ${error.message}`, 'error');
      }
    }

    async function triggerExpiration() {
      try {
        showStatus('🔄 手動觸發過期處理中...', 'loading');
        const response = await fetch(`${API_BASE}/manual-expiration-trigger`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.success) {
          showStatus(`✅ ${data.message}`, 'success');
          // 自動重新獲取過期信號
          setTimeout(fetchExpiredSignals, 1000);
        } else {
          showStatus(`❌ 觸發失敗: ${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`❌ 觸發過期處理失敗: ${error.message}`, 'error');
      }
    }

    async function checkSchedulerStatus() {
      try {
        showStatus('🔄 檢查調度器狀態中...', 'loading');
        const response = await fetch(`${API_BASE}/expiration-scheduler-status`);
        const data = await response.json();

        const container = document.getElementById('schedulerInfo');
        container.innerHTML = '<h2>🕐 調度器狀態</h2>';

        const status = data.scheduler_status;
        const statusHtml = `
                    <div class="signal-card">
                        <div class="signal-header">
                            調度器運行狀態
                            <span class="status ${status.is_running ? 'active' : 'expired'}">
                                ${status.is_running ? '運行中' : '已停止'}
                            </span>
                        </div>
                        <div class="signal-details">
                            <p><strong>檢查間隔:</strong> ${status.check_interval_seconds} 秒</p>
                            <p><strong>任務狀態:</strong> ${status.task_status}</p>
                            <p><strong>下次檢查:</strong> ${status.next_check || 'N/A'}</p>
                            <p><strong>當前時間:</strong> ${data.current_time}</p>
                        </div>
                    </div>
                `;
        container.innerHTML += statusHtml;

        showStatus(`✅ 調度器狀態: ${status.is_running ? '運行中' : '已停止'}`, 'success');
      } catch (error) {
        showStatus(`❌ 檢查調度器狀態失敗: ${error.message}`, 'error');
      }
    }

    function createSignalCard(signal, type) {
      const card = document.createElement('div');
      card.className = `signal-card ${type}`;

      const symbol = signal.symbol || 'Unknown';
      const signalType = signal.signal_type || signal.direction || 'Unknown';
      const confidence = signal.confidence ? (signal.confidence * 100).toFixed(1) : 'N/A';
      const createdAt = signal.created_at || signal.timestamp || 'Unknown';
      const reasoning = signal.reasoning || '無分析數據';

      let timeInfo = '';
      if (type === 'active') {
        const remaining = signal.remaining_time_minutes || 0;
        timeInfo = `<p><strong>剩餘時間:</strong> ${remaining.toFixed(1)} 分鐘</p>`;
        if (signal.recommended_duration_minutes) {
          timeInfo += `<p><strong>建議持續時間:</strong> ${signal.recommended_duration_minutes} 分鐘</p>`;
        }
      } else {
        const archivedAt = signal.archived_at || signal.expires_at || 'Unknown';
        timeInfo = `<p><strong>過期時間:</strong> ${archivedAt}</p>`;
        if (signal.data_source) {
          timeInfo += `<p><strong>數據來源:</strong> ${signal.data_source}</p>`;
        }
      }

      card.innerHTML = `
                <div class="signal-header">
                    ${symbol} ${signalType}
                    <span class="status ${type}">
                        ${type === 'active' ? '活躍' : '已過期'}
                    </span>
                </div>
                <div class="signal-details">
                    <p><strong>信心度:</strong> ${confidence}%</p>
                    <p><strong>創建時間:</strong> ${createdAt}</p>
                    ${timeInfo}
                    <p><strong>分析:</strong> ${reasoning}</p>
                </div>
            `;

      return card;
    }

    // 頁面載入時自動獲取數據
    window.onload = function () {
      fetchActiveSignals();
      fetchExpiredSignals();
      checkSchedulerStatus();
    };

    // 每30秒自動刷新狀態
    setInterval(() => {
      console.log('🔄 自動刷新狀態...');
      checkSchedulerStatus();
    }, 30000);
  </script>
</body>

</html>