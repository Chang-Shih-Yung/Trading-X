<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¯ ç‹™æ“Šæ‰‹æ­·å²æ•¸æ“šæ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .signal-card {
      border: 1px solid #ddd;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .signal-card.expired {
      border-color: #ff6b6b;
      background: #ffe0e0;
    }

    .signal-header {
      font-weight: bold;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .signal-details {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .status.expired {
      background: #ff6b6b;
      color: white;
    }

    .status.active {
      background: #51cf66;
      color: white;
    }

    button {
      background: #4c6ef5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #364fc7;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .error {
      background: #ffe0e0;
      color: #c92a2a;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .success {
      background: #d3f9d8;
      color: #2b8a3e;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ç‹™æ“Šæ‰‹æ­·å²æ•¸æ“šæ¸¬è©¦é é¢</h1>
      <p>æ¸¬è©¦åŸºæ–¼æ™ºèƒ½æ™‚é–“åˆ†å±¤å‹•æ…‹è¨ˆç®—çš„çœŸå¯¦éæœŸä¿¡è™Ÿ</p>
    </div>

    <div class="controls">
      <button onclick="fetchActiveSignals()">ç²å–æ´»èºä¿¡è™Ÿ</button>
      <button onclick="fetchExpiredSignals()">ç²å–éæœŸä¿¡è™Ÿ</button>
      <button onclick="triggerExpiration()">æ‰‹å‹•è§¸ç™¼éæœŸè™•ç†</button>
      <button onclick="checkSchedulerStatus()">æª¢æŸ¥èª¿åº¦å™¨ç‹€æ…‹</button>
    </div>

    <div id="status"></div>
    <div id="activeSignals"></div>
    <div id="expiredSignals"></div>
    <div id="schedulerInfo"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8000/api/v1/scalping';

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
      setTimeout(() => statusDiv.innerHTML = '', 5000);
    }

    async function fetchActiveSignals() {
      try {
        showStatus('ğŸ”„ ç²å–æ´»èºä¿¡è™Ÿä¸­...', 'loading');
        const response = await fetch(`${API_BASE}/dashboard-precision-signals`);
        const data = await response.json();

        const container = document.getElementById('activeSignals');
        container.innerHTML = '<h2>ğŸ¯ æ´»èºç‹™æ“Šæ‰‹ä¿¡è™Ÿ</h2>';

        if (data.signals && data.signals.length > 0) {
          data.signals.forEach(signal => {
            const card = createSignalCard(signal, 'active');
            container.appendChild(card);
          });
          showStatus(`âœ… ç²å–åˆ° ${data.signals.length} å€‹æ´»èºä¿¡è™Ÿ`, 'success');
        } else {
          container.innerHTML += '<p>æš«ç„¡æ´»èºä¿¡è™Ÿ</p>';
          showStatus('â„¹ï¸ æš«ç„¡æ´»èºä¿¡è™Ÿ', 'info');
        }
      } catch (error) {
        showStatus(`âŒ ç²å–æ´»èºä¿¡è™Ÿå¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function fetchExpiredSignals() {
      try {
        showStatus('ğŸ”„ ç²å–éæœŸä¿¡è™Ÿä¸­...', 'loading');
        const response = await fetch(`${API_BASE}/expired`);
        const data = await response.json();

        const container = document.getElementById('expiredSignals');
        container.innerHTML = '<h2>ğŸ“œ éæœŸç‹™æ“Šæ‰‹ä¿¡è™Ÿ (æ­·å²æ•¸æ“š)</h2>';

        let signals = [];
        if (data.signals) {
          signals = data.signals;
        } else if (Array.isArray(data)) {
          signals = data;
        }

        if (signals.length > 0) {
          signals.forEach(signal => {
            const card = createSignalCard(signal, 'expired');
            container.appendChild(card);
          });
          showStatus(`âœ… ç²å–åˆ° ${signals.length} å€‹éæœŸä¿¡è™Ÿ (æ•¸æ“šæº: ${data.data_source || 'unknown'})`, 'success');
        } else {
          container.innerHTML += '<p>âŒ æš«ç„¡éæœŸä¿¡è™Ÿ - é€™è¡¨ç¤ºæ­·å²æ•¸æ“šç‚ºç©ºï¼</p>';
          showStatus('âš ï¸ æ­·å²æ•¸æ“šç‚ºç©ºï¼éœ€è¦çœŸå¯¦çš„éæœŸä¿¡è™Ÿ', 'error');
        }
      } catch (error) {
        showStatus(`âŒ ç²å–éæœŸä¿¡è™Ÿå¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function triggerExpiration() {
      try {
        showStatus('ğŸ”„ æ‰‹å‹•è§¸ç™¼éæœŸè™•ç†ä¸­...', 'loading');
        const response = await fetch(`${API_BASE}/manual-expiration-trigger`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.success) {
          showStatus(`âœ… ${data.message}`, 'success');
          // è‡ªå‹•é‡æ–°ç²å–éæœŸä¿¡è™Ÿ
          setTimeout(fetchExpiredSignals, 1000);
        } else {
          showStatus(`âŒ è§¸ç™¼å¤±æ•—: ${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`âŒ è§¸ç™¼éæœŸè™•ç†å¤±æ•—: ${error.message}`, 'error');
      }
    }

    async function checkSchedulerStatus() {
      try {
        showStatus('ğŸ”„ æª¢æŸ¥èª¿åº¦å™¨ç‹€æ…‹ä¸­...', 'loading');
        const response = await fetch(`${API_BASE}/expiration-scheduler-status`);
        const data = await response.json();

        const container = document.getElementById('schedulerInfo');
        container.innerHTML = '<h2>ğŸ• èª¿åº¦å™¨ç‹€æ…‹</h2>';

        const status = data.scheduler_status;
        const statusHtml = `
                    <div class="signal-card">
                        <div class="signal-header">
                            èª¿åº¦å™¨é‹è¡Œç‹€æ…‹
                            <span class="status ${status.is_running ? 'active' : 'expired'}">
                                ${status.is_running ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢'}
                            </span>
                        </div>
                        <div class="signal-details">
                            <p><strong>æª¢æŸ¥é–“éš”:</strong> ${status.check_interval_seconds} ç§’</p>
                            <p><strong>ä»»å‹™ç‹€æ…‹:</strong> ${status.task_status}</p>
                            <p><strong>ä¸‹æ¬¡æª¢æŸ¥:</strong> ${status.next_check || 'N/A'}</p>
                            <p><strong>ç•¶å‰æ™‚é–“:</strong> ${data.current_time}</p>
                        </div>
                    </div>
                `;
        container.innerHTML += statusHtml;

        showStatus(`âœ… èª¿åº¦å™¨ç‹€æ…‹: ${status.is_running ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢'}`, 'success');
      } catch (error) {
        showStatus(`âŒ æª¢æŸ¥èª¿åº¦å™¨ç‹€æ…‹å¤±æ•—: ${error.message}`, 'error');
      }
    }

    function createSignalCard(signal, type) {
      const card = document.createElement('div');
      card.className = `signal-card ${type}`;

      const symbol = signal.symbol || 'Unknown';
      const signalType = signal.signal_type || signal.direction || 'Unknown';
      const confidence = signal.confidence ? (signal.confidence * 100).toFixed(1) : 'N/A';
      const createdAt = signal.created_at || signal.timestamp || 'Unknown';
      const reasoning = signal.reasoning || 'ç„¡åˆ†ææ•¸æ“š';

      let timeInfo = '';
      if (type === 'active') {
        const remaining = signal.remaining_time_minutes || 0;
        timeInfo = `<p><strong>å‰©é¤˜æ™‚é–“:</strong> ${remaining.toFixed(1)} åˆ†é˜</p>`;
        if (signal.recommended_duration_minutes) {
          timeInfo += `<p><strong>å»ºè­°æŒçºŒæ™‚é–“:</strong> ${signal.recommended_duration_minutes} åˆ†é˜</p>`;
        }
      } else {
        const archivedAt = signal.archived_at || signal.expires_at || 'Unknown';
        timeInfo = `<p><strong>éæœŸæ™‚é–“:</strong> ${archivedAt}</p>`;
        if (signal.data_source) {
          timeInfo += `<p><strong>æ•¸æ“šä¾†æº:</strong> ${signal.data_source}</p>`;
        }
      }

      card.innerHTML = `
                <div class="signal-header">
                    ${symbol} ${signalType}
                    <span class="status ${type}">
                        ${type === 'active' ? 'æ´»èº' : 'å·²éæœŸ'}
                    </span>
                </div>
                <div class="signal-details">
                    <p><strong>ä¿¡å¿ƒåº¦:</strong> ${confidence}%</p>
                    <p><strong>å‰µå»ºæ™‚é–“:</strong> ${createdAt}</p>
                    ${timeInfo}
                    <p><strong>åˆ†æ:</strong> ${reasoning}</p>
                </div>
            `;

      return card;
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•ç²å–æ•¸æ“š
    window.onload = function () {
      fetchActiveSignals();
      fetchExpiredSignals();
      checkSchedulerStatus();
    };

    // æ¯30ç§’è‡ªå‹•åˆ·æ–°ç‹€æ…‹
    setInterval(() => {
      console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°ç‹€æ…‹...');
      checkSchedulerStatus();
    }, 30000);
  </script>
</body>

</html>