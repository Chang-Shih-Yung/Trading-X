# ğŸ”§ çŸ­ç·šä¿¡è™Ÿç”Ÿå‘½é€±æœŸä¿®å¾©å ±å‘Š

## ğŸš¨ åŸå•é¡Œåˆ†æ

### ç”¨æˆ¶æŒ‡å‡ºçš„é‚è¼¯çŸ›ç›¾ï¼š

```
"èˆŠä¿¡è™Ÿæ¸…ç†: _cleanup_old_signals_for_symbol() åœ¨æ–°å¢å‰æœƒæ¸…ç†åŒä¸€äº¤æ˜“å°çš„èˆŠä¿¡è™Ÿã€‚
é€™å€‹æœ‰å•é¡Œï¼Œå› ç‚ºæˆ‘å¿…é ˆä¿ç•™æ‰€æœ‰èˆŠçš„ä¿¡è™Ÿï¼Œç›´åˆ°ä¸ƒå¤©å¾Œæ‰åˆªé™¤ï¼Œåœ¨é€™æœŸé–“èˆŠçš„ä¿¡è™Ÿéƒ½è¦å‘ˆç¾éæœŸçš„ç‹€æ…‹ã€‚"
```

### ç³»çµ±åŸæœ‰çš„éŒ¯èª¤æµç¨‹ï¼š

1. **æ–°ä¿¡è™Ÿç”Ÿæˆæ™‚** â†’ `_cleanup_old_signals_for_symbol(symbol)` ç«‹å³æ¸…ç†èˆŠä¿¡è™Ÿ
2. **èˆŠä¿¡è™Ÿè¢«æ¨™è¨˜ç‚º** `status = 'replaced'` ä¸¦è¨­ç½® `archived_at`
3. **çµæœ**: èˆŠä¿¡è™Ÿç«‹å³è¢«"æ¸…ç†"ï¼Œç„¡æ³•é€²å…¥è‡ªç„¶éæœŸæµç¨‹

### å°è‡´çš„å•é¡Œï¼š

- âŒ `/expired` ç«¯é»æ°¸é è¿”å›ç©ºçµæœ
- âŒ ç„¡æ³•æŸ¥è©¢æ­·å²éæœŸä¿¡è™Ÿ
- âŒ é•åäº†"éæœŸä¿¡è™Ÿä¸æœƒè¢«åˆªé™¤ï¼Œè€Œæ˜¯æ”¹è®Šç‹€æ…‹ä¿å­˜"çš„è¨­è¨ˆåŸå‰‡

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. ç§»é™¤ç«‹å³æ¸…ç†æ©Ÿåˆ¶

**ä¿®æ”¹æ–‡ä»¶**: `app/api/v1/endpoints/scalping_precision.py`

**ä¿®æ”¹å…§å®¹**:

```python
# ğŸš« åŸä¾†çš„éŒ¯èª¤é‚è¼¯
if precision_signal:
    await _cleanup_old_signals_for_symbol(symbol)  # âŒ ç«‹å³æ¸…ç†èˆŠä¿¡è™Ÿ
    await _save_precision_signal_to_db(precision_signal)

# âœ… ä¿®å¾©å¾Œçš„æ­£ç¢ºé‚è¼¯
if precision_signal:
    await _save_precision_signal_to_db(precision_signal)  # âœ… åƒ…ä¿å­˜æ–°ä¿¡è™Ÿ
```

### 2. é‡æ–°å®šç¾©æ¸…ç†å‡½æ•¸

```python
async def _cleanup_old_signals_for_symbol(symbol: str):
    """
    ğŸš« å·²æ£„ç”¨ï¼šä¸å†æ¸…ç†åŒäº¤æ˜“å°çš„èˆŠä¿¡è™Ÿ

    åŸå› ï¼šé€™æœƒç ´å£æ­·å²ä¿¡è™Ÿä¿å­˜æ©Ÿåˆ¶
    æ–°æ©Ÿåˆ¶ï¼šè®“ä¿¡è™Ÿè‡ªç„¶éæœŸï¼Œä¿å­˜7å¤©å¾Œå†æ¸…ç†
    """
    logger.warning(f"âš ï¸  _cleanup_old_signals_for_symbol() å·²æ£„ç”¨ï¼Œä¿¡è™Ÿå°‡è‡ªç„¶éæœŸ")
    pass
```

### 3. æ·»åŠ çœŸæ­£çš„ 7 å¤©æ¸…ç†æ©Ÿåˆ¶

```python
async def _cleanup_signals_older_than_7_days():
    """æ¸…ç†7å¤©å‰çš„éæœŸä¿¡è™Ÿ - çœŸæ­£çš„æ¸…ç†æ©Ÿåˆ¶"""
    try:
        seven_days_ago = get_taiwan_now().replace(tzinfo=None) - timedelta(days=7)

        delete_query = text("""
            DELETE FROM trading_signals
            WHERE status IN ('expired', 'replaced', 'archived')
            AND (archived_at IS NOT NULL AND datetime(archived_at) <= datetime(:seven_days_ago))
            OR (expires_at IS NOT NULL AND datetime(expires_at) <= datetime(:seven_days_ago))
        """)

        result = db.execute(delete_query, {"seven_days_ago": seven_days_ago.isoformat()})
        return result.rowcount
```

### 4. æ–°å¢ API ç«¯é»

```python
@router.post("/cleanup-expired")
async def cleanup_expired_signals():
    """æ‰‹å‹•æ¸…ç†7å¤©å‰çš„éæœŸä¿¡è™Ÿ"""
```

## ğŸ§ª æ¸¬è©¦é©—è­‰

### æ¸¬è©¦å ´æ™¯å‰µå»ºï¼š

1. **æ´»èºä¿¡è™Ÿ**: BTCUSDT (4 å°æ™‚å¾ŒéæœŸ)
2. **1 å°æ™‚å‰éæœŸ**: ETHUSDT (æ‡‰ä¿ç•™åœ¨æ­·å²ä¸­)
3. **8 å¤©å‰éæœŸ**: ADAUSDT (æ‡‰è¢«æ¸…ç†)

### æ¸¬è©¦çµæœï¼š

```bash
# 1. éæœŸä¿¡è™ŸæŸ¥è©¢æ­£å¸¸å·¥ä½œ
curl "/api/v1/scalping/expired"
# è¿”å›: 2å€‹éæœŸä¿¡è™Ÿ (1å°æ™‚å‰ + 8å¤©å‰)

# 2. 7å¤©æ¸…ç†æ©Ÿåˆ¶æ­£å¸¸å·¥ä½œ
curl -X POST "/api/v1/scalping/cleanup-expired"
# è¿”å›: {"deleted_count": 1} (åˆªé™¤äº†8å¤©å‰çš„ä¿¡è™Ÿ)

# 3. å†æ¬¡æŸ¥è©¢åªå‰©1å°æ™‚å‰çš„ä¿¡è™Ÿ
curl "/api/v1/scalping/expired"
# è¿”å›: 1å€‹éæœŸä¿¡è™Ÿ (åƒ…ä¿ç•™1å°æ™‚å‰çš„)
```

## ğŸ“‹ æ­£ç¢ºçš„ä¿¡è™Ÿç”Ÿå‘½é€±æœŸ

### æ–°çš„æµç¨‹ï¼š

1. **ä¿¡è™Ÿç”Ÿæˆ** â†’ ç›´æ¥ä¿å­˜ï¼Œä¸æ¸…ç†èˆŠä¿¡è™Ÿ
2. **ä¿¡è™ŸéæœŸ** â†’ ç”±æ™‚é–“é©…å‹• (`expires_at` åˆ°æœŸ)
3. **ç‹€æ…‹è®Šæ›´** â†’ `active` â†’ `expired`
4. **æ­·å²ä¿å­˜** â†’ éæœŸä¿¡è™Ÿä¿å­˜ 7 å¤©ä¾›æŸ¥è©¢
5. **æœ€çµ‚æ¸…ç†** â†’ 7 å¤©å¾Œå¾¹åº•åˆªé™¤

### API ç«¯é»åŠŸèƒ½ï¼š

- âœ… `/signals` - è¿”å›æ´»èºä¿¡è™Ÿ
- âœ… `/expired` - è¿”å›éæœŸä¿¡è™Ÿæ­·å²
- âœ… `/cleanup-expired` - æ¸…ç† 7 å¤©å‰çš„éæœŸä¿¡è™Ÿ
- âœ… `/process-expired` - è™•ç†å³å°‡éæœŸçš„ä¿¡è™Ÿ

## ğŸ¯ ä¿®å¾©é©—è­‰

### 1. æ­·å²ä¿¡è™Ÿä¿å­˜ âœ…

- éæœŸä¿¡è™Ÿä¸å†è¢«ç«‹å³æ¸…ç†
- `/expired` ç«¯é»æ­£å¸¸è¿”å›æ­·å²è¨˜éŒ„

### 2. å–®ä¸€ä¿¡è™Ÿä¿è­‰ âœ…

- ç²¾æº–ç¯©é¸æ©Ÿåˆ¶ç¢ºä¿æ¯å€‹å¹£ç¨®åªæœ‰ä¸€å€‹æœ€ä½³ä¿¡è™Ÿ
- æ–°ä¿¡è™Ÿä¸æœƒå½±éŸ¿èˆŠä¿¡è™Ÿçš„ç”Ÿå‘½é€±æœŸ

### 3. æ•¸æ“šå®Œæ•´æ€§ âœ…

- éæœŸä¿¡è™Ÿä¿å­˜ 7 å¤©
- 7 å¤©å¾Œè‡ªå‹•æ¸…ç†ï¼Œç¯€çœå­˜å„²ç©ºé–“

### 4. é›¶å‚™é¸æ¨¡å¼ âœ…

- ç­–ç•¥ç«¶çˆ­ï¼Œåªä¿ç•™æœ€ç²¾æº–çš„ä¿¡è™Ÿ
- å‚™é¸ä¿¡è™Ÿåœ¨ç”Ÿæˆéšæ®µå°±è¢«æ·˜æ±°

## ğŸ”® å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **å®šæœŸä»»å‹™**: æ·»åŠ  cron job æ¯å¤©è‡ªå‹•åŸ·è¡Œ 7 å¤©æ¸…ç†
2. **ç›£æ§æ©Ÿåˆ¶**: æ·»åŠ éæœŸä¿¡è™Ÿçµ±è¨ˆå’Œç›£æ§
3. **é…ç½®åŒ–**: å°‡ä¿å­˜æœŸé™è¨­ç‚ºå¯é…ç½®åƒæ•¸
4. **å£“ç¸®æ­¸æª”**: è€ƒæ…®å°‡è€ä¿¡è™Ÿç§»è‡³æ­¸æª”è¡¨è€Œéç›´æ¥åˆªé™¤

---

**ä¿®å¾©å®Œæˆæ™‚é–“**: 2025-07-29 18:27  
**ä¿®å¾©ç¯„åœ**: ä¿¡è™Ÿç”Ÿå‘½é€±æœŸç®¡ç†é‚è¼¯  
**å½±éŸ¿ç¯„åœ**: ç²¾æº–ä¿¡è™Ÿç¯©é¸ç³»çµ±  
**æ¸¬è©¦ç‹€æ…‹**: âœ… é€šéå®Œæ•´æ¸¬è©¦
