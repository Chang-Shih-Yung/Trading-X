<template>
  <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">æ–°èèˆ‡æ•¸æ“šåˆ†æ</h1>
      <p class="text-gray-600">å¤šç¶­åº¦æ•¸æ“šæ•´åˆï¼šæ–°èã€éˆä¸Šæ•¸æ“šã€å®è§€ç¶“æ¿ŸæŒ‡æ¨™</p>
    </div>

    <!-- æ•¸æ“šçµ±è¨ˆå¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-blue-100 rounded-lg">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">ä»Šæ—¥æ–°è</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.todayNews }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-green-100 rounded-lg">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">éˆä¸Šäº‹ä»¶</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.onchainEvents }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-yellow-100 rounded-lg">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">ç¶“æ¿ŸæŒ‡æ¨™</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.economicIndicators }}</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-2 bg-purple-100 rounded-lg">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-600">AI æƒ…ç·’åˆ†æ</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.sentimentScore }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- AI æ–°èæ‘˜è¦ -->
    <div class="bg-white rounded-lg shadow mb-8">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">ğŸ“Š å¸‚å ´æ‘˜è¦åˆ†æ</h2>
          <button @click="refreshAISummary" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            é‡æ–°åˆ†æ
          </button>
        </div>
      </div>
      <div class="p-6">
        <div v-if="loading.aiSummary" class="flex justify-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
        <div v-else class="space-y-4">
          <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
            <h3 class="text-lg font-medium text-blue-900 mb-2">å¸‚å ´é—œéµæ‘˜è¦</h3>
            <p class="text-blue-700">{{ aiSummary.keyPoints || 'æ­£åœ¨åˆ†ææœ€æ–°å¸‚å ´å‹•æ…‹...' }}</p>
          </div>
          <div class="bg-green-50 border-l-4 border-green-400 p-4">
            <h3 class="text-lg font-medium text-green-900 mb-2">æ­£é¢å½±éŸ¿å› ç´ </h3>
            <p class="text-green-700">{{ aiSummary.positiveFactors || 'åˆ†æä¸­...' }}</p>
          </div>
          <div class="bg-red-50 border-l-4 border-red-400 p-4">
            <h3 class="text-lg font-medium text-red-900 mb-2">é¢¨éšªè­¦ç¤º</h3>
            <p class="text-red-700">{{ aiSummary.riskFactors || 'åˆ†æä¸­...' }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- é‡é»æ•¸æ“šå€å¡Š -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- éˆä¸Šæ•¸æ“šåˆ†æ -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">ğŸ”— éˆä¸Šæ•¸æ“šåˆ†æ</h2>
        </div>
        <div class="p-6">
          <div v-if="loading.onchain" class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
          </div>
          <div v-else class="space-y-4">
            <div v-for="metric in onchainMetrics" :key="metric.name" class="flex justify-between items-center p-3 bg-gray-50 rounded">
              <span class="font-medium">{{ metric.name }}</span>
              <span class="text-lg font-bold" :class="metric.trend === 'up' ? 'text-green-600' : metric.trend === 'down' ? 'text-red-600' : 'text-gray-600'">
                {{ metric.value }}
                <svg v-if="metric.trend === 'up'" class="inline w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/>
                </svg>
                <svg v-else-if="metric.trend === 'down'" class="inline w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z"/>
                </svg>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- å®è§€ç¶“æ¿ŸæŒ‡æ¨™ -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">ğŸ“Š å®è§€ç¶“æ¿ŸæŒ‡æ¨™</h2>
        </div>
        <div class="p-6">
          <div v-if="loading.economic" class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600"></div>
          </div>
          <div v-else class="space-y-4">
            <div v-for="indicator in economicData" :key="indicator.name" class="flex justify-between items-center p-3 bg-gray-50 rounded">
              <span class="font-medium">{{ indicator.name }}</span>
              <span class="text-lg font-bold" :class="indicator.impact === 'positive' ? 'text-green-600' : indicator.impact === 'negative' ? 'text-red-600' : 'text-gray-600'">
                {{ indicator.value }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ–°èåˆ—è¡¨ -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">ğŸ“° æœ€æ–°å¸‚å ´æ–°è</h2>
          <select v-model="selectedCategory" @change="filterNews" class="px-3 py-1 border rounded-md">
            <option value="all">å…¨éƒ¨é¡åˆ¥</option>
            <option value="crypto">åŠ å¯†è²¨å¹£</option>
            <option value="defi">DeFi</option>
            <option value="nft">NFT</option>
            <option value="regulation">ç›£ç®¡</option>
            <option value="technology">ç§‘æŠ€</option>
          </select>
        </div>
      </div>
      <div class="p-6">
        <div v-if="loading.news" class="flex justify-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
        <div v-else class="space-y-6">
          <div v-for="article in filteredNews" :key="article.id" class="border-b pb-4 last:border-b-0">
            <div class="flex justify-between items-start mb-2">
              <h3 
                class="text-lg font-semibold flex-1 cursor-pointer hover:text-blue-600 transition-colors"
                :class="getUrlStatusClass(article.url)"
                @click="openArticle(article.url, article)"
                :title="getUrlStatusText(article.url)"
              >
                <span v-if="article.translated" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mr-2">ä¸­æ–‡</span>
                {{ article.title }}
                <span v-if="!isValidUrl(article.url)" class="text-xs text-gray-400 ml-2">ğŸ“„</span>
                <span v-else class="text-xs text-green-500 ml-2">ğŸ”—</span>
              </h3>
              <div class="flex items-center space-x-2 ml-4">
                <span class="text-xs px-2 py-1 rounded-full" :class="getCategoryColor(article.category)">
                  {{ getCategoryText(article.category) }}
                </span>
                <img v-if="article.image" :src="article.image" alt="æ–°èåœ–ç‰‡" class="w-12 h-12 rounded object-cover">
              </div>
            </div>
            <p class="text-gray-600 mb-3">{{ article.summary }}</p>
            <div class="flex justify-between items-center text-sm">
              <div class="flex items-center space-x-2 text-gray-500">
                <span class="font-medium">{{ article.source }}</span>
                <span>{{ formatDate(article.publishedAt) }}</span>
              </div>
              <div class="flex items-center space-x-2">
                <button 
                  @click="translateArticle(article)" 
                  :disabled="loading.translate === article.id"
                  class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50 transition-colors"
                >
                  <span v-if="loading.translate === article.id">ç¿»è­¯ä¸­...</span>
                  <span v-else-if="article.translated">é‚„åŸ</span>
                  <span v-else>ğŸˆšï¸ ä¸­æ–‡</span>
                </button>
                <button 
                  @click="copyNewsLink(article)" 
                  class="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                >
                  ğŸ“‹ è¤‡è£½é€£çµ
                </button>
                <button 
                  v-if="isValidUrl(article.url)"
                  @click="openArticleSafely(article.url, article.title)"
                  class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                >
                  ğŸ”— é–‹å•Ÿ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, computed } from 'vue'
import axios from 'axios'

interface NewsArticle {
  id: string
  title: string
  summary: string
  url: string
  source: string
  publishedAt: string
  category: string
  sentiment?: 'positive' | 'negative' | 'neutral'
  image?: string
  translated?: boolean
  original_title?: string
  original_summary?: string
}

interface OnchainMetric {
  name: string
  value: string
  trend: 'up' | 'down' | 'stable'
}

interface EconomicIndicator {
  name: string
  value: string
  impact: 'positive' | 'negative' | 'neutral'
}

const stats = reactive({
  todayNews: 0,
  onchainEvents: 0,
  economicIndicators: 0,
  sentimentScore: 'ä¸­æ€§'
})

const loading = reactive({
  news: false,
  aiSummary: false,
  onchain: false,
  economic: false,
  translate: ''
})

const aiSummary = reactive({
  keyPoints: '',
  positiveFactors: '',
  riskFactors: ''
})

const news = ref<NewsArticle[]>([])
const selectedCategory = ref('all')
const onchainMetrics = ref<OnchainMetric[]>([])
const economicData = ref<EconomicIndicator[]>([])

const filteredNews = computed(() => {
  if (selectedCategory.value === 'all') {
    return news.value
  }
  return news.value.filter(article => article.category === selectedCategory.value)
})

const fetchNews = async () => {
  loading.news = true
  try {
    const response = await axios.get('/api/v1/news/latest')
    news.value = response.data
    stats.todayNews = news.value.length
  } catch (error) {
    console.error('ç²å–æ–°èå¤±æ•—:', error)
    // æ¨¡æ“¬æ•¸æ“š
    news.value = [
      {
        id: '1',
        title: 'Bitcoin çªç ´ 45,000 ç¾å…ƒé—œéµé˜»åŠ›ä½',
        summary: 'BTC åœ¨æ©Ÿæ§‹æŠ•è³‡è€…æŒçºŒæµå…¥çš„æ¨å‹•ä¸‹ï¼ŒæˆåŠŸçªç ´æŠ€è¡“åˆ†æé—œéµé˜»åŠ›ä½ï¼Œå¸‚å ´æƒ…ç·’è½‰ç‚ºæ¨‚è§€...',
        url: '#',
        source: 'CoinDesk',
        publishedAt: new Date().toISOString(),
        category: 'crypto',
        sentiment: 'positive'
      },
      {
        id: '2',
        title: 'ç¾è¯å„²æš—ç¤ºå¯èƒ½æš«åœå‡æ¯',
        summary: 'è¯æº–æœƒä¸»å¸­é®‘å¨çˆ¾åœ¨æœ€æ–°æ¼”è¬›ä¸­è¡¨ç¤ºï¼Œè€ƒæ…®åˆ°é€šè„¹æ•¸æ“šçš„æ”¹å–„ï¼Œæœªä¾†å‡æ¯æ­¥èª¿å¯èƒ½æ”¾ç·©...',
        url: '#',
        source: 'Reuters',
        publishedAt: new Date().toISOString(),
        category: 'economy',
        sentiment: 'positive'
      }
    ]
    stats.todayNews = news.value.length
  } finally {
    loading.news = false
  }
}

const fetchAISummary = async () => {
  loading.aiSummary = true
  try {
    const response = await axios.get('/api/v1/news/ai-summary')
    Object.assign(aiSummary, response.data)
  } catch (error) {
    console.error('ç²å–AIæ‘˜è¦å¤±æ•—:', error)
    // æ¨¡æ“¬æ•¸æ“š
    aiSummary.keyPoints = 'å¸‚å ´å‘ˆç¾è¬¹æ…æ¨‚è§€æ…‹å‹¢ï¼Œæ¯”ç‰¹å¹£çªç ´é—œéµé˜»åŠ›ä½ï¼Œæ©Ÿæ§‹è³‡é‡‘æŒçºŒæµå…¥ã€‚ç¾è¯å„²æ”¿ç­–ç«‹å ´è»ŸåŒ–ç‚ºé¢¨éšªè³‡ç”¢æä¾›æ”¯æ’ã€‚'
    aiSummary.positiveFactors = '1. æ©Ÿæ§‹æŠ•è³‡è€…æŒçºŒå¢æŒåŠ å¯†è²¨å¹£ 2. ç¾è¯å„²å‡æ¯æ­¥èª¿æ”¾ç·©é æœŸ 3. æŠ€è¡“é¢çªç ´é—œéµé˜»åŠ›ä½'
    aiSummary.riskFactors = '1. å…¨çƒç¶“æ¿Ÿè¡°é€€é¢¨éšªä»å­˜ 2. ç›£ç®¡æ”¿ç­–ä¸ç¢ºå®šæ€§ 3. å¸‚å ´æµå‹•æ€§åç·Š'
  } finally {
    loading.aiSummary = false
  }
}

const fetchOnchainData = async () => {
  loading.onchain = true
  try {
    const response = await axios.get('/api/v1/news/onchain-metrics')
    onchainMetrics.value = response.data
  } catch (error) {
    console.error('ç²å–éˆä¸Šæ•¸æ“šå¤±æ•—:', error)
    // æ¨¡æ“¬æ•¸æ“š
    onchainMetrics.value = [
      { name: 'å¤§é¡è½‰å¸³æ•¸é‡', value: '+15%', trend: 'up' },
      { name: 'äº¤æ˜“æ‰€æµå…¥é‡', value: '2,450 BTC', trend: 'down' },
      { name: 'æ´»èºåœ°å€æ•¸', value: '985,432', trend: 'up' },
      { name: 'MVRV æ¯”ç‡', value: '1.25', trend: 'stable' },
      { name: 'æŒå¹£å¤§æˆ¶æ•¸é‡', value: '2,156', trend: 'up' }
    ]
    stats.onchainEvents = 5
  } finally {
    loading.onchain = false
  }
}

const fetchEconomicData = async () => {
  loading.economic = true
  try {
    const response = await axios.get('/api/v1/news/economic-indicators')
    economicData.value = response.data
  } catch (error) {
    console.error('ç²å–ç¶“æ¿ŸæŒ‡æ¨™å¤±æ•—:', error)
    // æ¨¡æ“¬æ•¸æ“š
    economicData.value = [
      { name: 'ç¾åœ‹ CPI', value: '3.2%', impact: 'neutral' },
      { name: 'DXY ç¾å…ƒæŒ‡æ•¸', value: '103.45', impact: 'negative' },
      { name: '10å¹´æœŸç¾å‚µæ”¶ç›Šç‡', value: '4.25%', impact: 'negative' },
      { name: 'VIX ææ…ŒæŒ‡æ•¸', value: '16.8', impact: 'positive' },
      { name: 'NASDAQ 100', value: '+1.2%', impact: 'positive' }
    ]
    stats.economicIndicators = 5
  } finally {
    loading.economic = false
  }
}

const refreshAISummary = () => {
  fetchAISummary()
}

const filterNews = () => {
  // ç¯©é¸é‚è¼¯å·²åœ¨ computed ä¸­è™•ç†
}

const openArticle = (url: string, article?: NewsArticle) => {
  // æª¢æŸ¥URLæœ‰æ•ˆæ€§
  if (!url || url === '#' || url === '' || url.includes('example.com')) {
    // å¦‚æœæ˜¯ç„¡æ•ˆURLï¼Œé¡¯ç¤ºæç¤ºä¸¦è¿”å›
    alert('æ­¤æ–°èæš«æ™‚ç„¡æ³•è·³è½‰ï¼Œè«‹ç¨å¾Œå†è©¦')
    return
  }
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„HTTP/HTTPS URL
  try {
    const urlObj = new URL(url)
    if (urlObj.protocol === 'http:' || urlObj.protocol === 'https:') {
      // åœ¨æ–°æ¨™ç±¤é ä¸­å®‰å…¨åœ°é–‹å•Ÿé€£çµ
      const newWindow = window.open(url, '_blank', 'noopener,noreferrer')
      if (!newWindow) {
        // å¦‚æœå½ˆå‡ºè¦–çª—è¢«é˜»æ“‹
        const shouldCopy = confirm(`å½ˆå‡ºè¦–çª—è¢«ç€è¦½å™¨é˜»æ“‹ã€‚\n\næ˜¯å¦è¦è¤‡è£½é€£çµï¼Ÿ\n${url}`)
        if (shouldCopy) {
          copyToClipboard(url, article?.title || 'æ–°èé€£çµ')
        }
      }
    } else {
      alert('ç„¡æ•ˆçš„ç¶²å€æ ¼å¼')
    }
  } catch (error) {
    // URLæ ¼å¼éŒ¯èª¤
    console.error('URLè§£æéŒ¯èª¤:', error)
    alert('ç¶²å€æ ¼å¼æœ‰èª¤ï¼Œç„¡æ³•é–‹å•Ÿ')
  }
}

const openArticleSafely = (url: string, title: string) => {
  try {
    const newWindow = window.open(url, '_blank', 'noopener,noreferrer')
    if (!newWindow) {
      const shouldCopy = confirm(`å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œæ˜¯å¦è¤‡è£½é€£çµï¼Ÿ\n\næ¨™é¡Œï¼š${title}\né€£çµï¼š${url}`)
      if (shouldCopy) {
        copyToClipboard(url, title)
      }
    }
  } catch (error) {
    console.error('é–‹å•Ÿé€£çµå¤±æ•—:', error)
    copyToClipboard(url, title)
  }
}

const copyToClipboard = async (text: string, title?: string) => {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text)
      alert(`âœ… é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n${title || 'æ–°èé€£çµ'}`)
    } else {
      // é™ç´šæ–¹æ¡ˆï¼šä½¿ç”¨èˆŠæ–¹æ³•
      const textArea = document.createElement('textarea')
      textArea.value = text
      textArea.style.position = 'fixed'
      textArea.style.left = '-999999px'
      textArea.style.top = '-999999px'
      document.body.appendChild(textArea)
      textArea.focus()
      textArea.select()
      
      try {
        document.execCommand('copy')
        alert(`âœ… é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\n${title || 'æ–°èé€£çµ'}`)
      } catch (err) {
        console.error('è¤‡è£½å¤±æ•—:', err)
        alert(`âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n\n${text}`)
      } finally {
        document.body.removeChild(textArea)
      }
    }
  } catch (error) {
    console.error('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—:', error)
    alert(`âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n\n${text}`)
  }
}

const copyNewsLink = async (article: NewsArticle) => {
  await copyToClipboard(article.url, article.title)
}

const translateArticle = async (article: NewsArticle) => {
  if (article.translated) {
    // é‚„åŸåˆ°åŸå§‹å…§å®¹
    article.title = article.original_title || article.title
    article.summary = article.original_summary || article.summary
    article.translated = false
    return
  }
  
  loading.translate = article.id
  
  try {
    const response = await axios.post(`/api/v1/news/translate`, null, {
      params: {
        news_id: article.id,
        target_language: 'zh-TW'
      }
    })
    
    // ä¿å­˜åŸå§‹å…§å®¹
    if (!article.original_title) {
      article.original_title = article.title
      article.original_summary = article.summary
    }
    
    // æ›´æ–°ç‚ºç¿»è­¯å…§å®¹
    article.title = response.data.title
    article.summary = response.data.summary
    article.translated = true
    
    // åœ¨æ–°èåˆ—è¡¨ä¸­æ›´æ–°è©²æ–‡ç« 
    const index = news.value.findIndex(n => n.id === article.id)
    if (index !== -1) {
      news.value[index] = { ...article }
    }
    
  } catch (error) {
    console.error('ç¿»è­¯å¤±æ•—:', error)
    alert('ç¿»è­¯æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦')
  } finally {
    loading.translate = ''
  }
}

const getCategoryColor = (category: string) => {
  const colors = {
    crypto: 'bg-orange-100 text-orange-800',
    economy: 'bg-blue-100 text-blue-800',
    technology: 'bg-green-100 text-green-800',
    defi: 'bg-purple-100 text-purple-800',
    nft: 'bg-pink-100 text-pink-800',
    regulation: 'bg-red-100 text-red-800'
  }
  return colors[category as keyof typeof colors] || 'bg-gray-100 text-gray-800'
}

const getCategoryText = (category: string) => {
  const texts = {
    crypto: 'åŠ å¯†è²¨å¹£',
    economy: 'ç¶“æ¿Ÿ',
    technology: 'ç§‘æŠ€',
    defi: 'DeFi',
    nft: 'NFT',
    regulation: 'ç›£ç®¡'
  }
  return texts[category as keyof typeof texts] || category
}

const formatDate = (dateString: string) => {
  const date = new Date(dateString)
  return date.toLocaleString('zh-TW')
}

const isValidUrl = (url: string) => {
  if (!url || url === '#' || url === '' || url.includes('example.com')) {
    return false
  }
  try {
    const urlObj = new URL(url)
    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:'
  } catch {
    return false
  }
}

const getUrlStatusClass = (url: string) => {
  return isValidUrl(url) ? 'text-gray-900' : 'text-gray-500'
}

const getUrlStatusText = (url: string) => {
  return isValidUrl(url) ? 'é»æ“ŠæŸ¥çœ‹å®Œæ•´æ–°è' : 'é è¦½æ¨¡å¼ - æš«ç„¡å¤–éƒ¨é€£çµ'
}

onMounted(() => {
  fetchNews()
  fetchAISummary()
  fetchOnchainData()
  fetchEconomicData()
  
  // è¨ˆç®—æ•´é«”æƒ…ç·’åˆ†æ•¸
  setTimeout(() => {
    const positiveCount = news.value.filter(n => n.sentiment === 'positive').length
    const totalCount = news.value.length
    if (totalCount > 0) {
      const positiveRatio = positiveCount / totalCount
      if (positiveRatio > 0.6) stats.sentimentScore = 'æ¨‚è§€'
      else if (positiveRatio < 0.4) stats.sentimentScore = 'æ‚²è§€'
      else stats.sentimentScore = 'ä¸­æ€§'
    }
  }, 1000)
})
</script>
