# 🎯 Phase5 Lean：相似度回測（實戰優化版）

## 📋 設計理念

### 核心哲學：形狀比較 > 指標堆砌

- **只比「形狀」**：用報酬率序列與波動正規化，避免多指標過擬合
- **制度先行**：在同市場環境下比較歷史相似度，降低偽關聯
- **實戰導向**：內建保守成本模型與流動性限制

### 與原版本對比優化

| 項目       | 原版本               | Phase5 Lean             |
| ---------- | -------------------- | ----------------------- |
| 指標數量   | 60+ 技術指標         | 3 個核心序列            |
| 時間框架   | H1/H4/D1/W1 均等投票 | H4+D1 主導，W1 制度閘門 |
| 相似度計算 | 多維度加權           | 純形狀：收益+單一濾波   |
| 驗證方式   | 歷史回測             | Rolling Walk-Forward    |
| 執行模型   | 理想化               | 保守成本+流動性限制     |

---

## 🏗️ 系統架構

### 1. 資料期間與深度限制

```python
# 有效期間判定
- 主流幣：2018/2019+ 深度穩定期
- 山寨幣：日均成交/委託簿深度檢查
- 低流動性 → 禁用 H1/H4，僅允許 D1/W1
```

### 2. 特徵瘦身（避免過擬合）

```python
# 僅用 3 個序列
r_t = log_close.diff()                    # 收益形狀
vol_regime = |r_t| 的分位桶 (低/中/高)     # 波動制度
z_rsi = RSI z-score                       # 單一技術濾波

# 相似度計算
similarity = cosine(current_r, hist_r) × 0.7 + cosine(z_rsi, z_rsi_hist) × 0.3
```

### 3. 制度分類（Regime Detection）

```python
# 6種市場制度
regime = trend_direction × volatility_bucket
- trend: up/down/range (60日斜率)
- volatility: high/mid/low (30日實際波動分位)

# 同制度內比對，避免牛市找熊市相似度
```

---

## ⚖️ 多時間框架投票機制

### 簡化投票權重

```python
# 主投票框架
H4: 權重 0.45  # 短期趨勢
D1: 權重 0.55  # 中期趨勢

# 制度閘門（不參與投票）
W1: 僅做允許/禁止判斷
- 禁止：trend_up + high_vol 時做空
- 禁止：trend_down + high_vol 時做多
```

### 投票流程

1. **H4/D1** 各自找 top-20 相似片段
2. **統計後續 N 根**的方向勝率與期望收益
3. **W1 制度檢查**：通過才允許入場
4. **最終決策**：加權投票 + 執行過濾

---

## 🎯 入場與風控邏輯

### 入場條件（三重過濾）

```python
# 1. 統計顯著性
P(±x%) > 58%  # 方向勝率門檻

# 2. 期望收益超成本
E[return|signal] > 手續費 + 滑點 × 2

# 3. 制度閘門通過
not in 高波動極端趨勢期
```

### 倉位計算

```python
# 波動倒數縮放
size = base_size × min(1.0, target_risk / realized_volatility)

# 目標：單筆風險控制在 0.5-2%
```

### 退出機制

```python
止損: ATR × 1.5
止盈: 分批 [1R, 2R]
時間: N根後強制平倉
```

---

## 🔬 Walk-Forward 驗證框架

### 滾動窗口設計

```python
# 樣本切分
訓練窗口: 過去 24 個月 (建立規則)
測試窗口: 前推 3 個月 (OOS驗證)
滾動頻率: 每 3 個月向前推進

# 嚴格前驗證
- In-sample: 只建立相似度閾值、勝率門檻
- Out-of-sample: 完全未見過的數據
```

### 績效指標

```python
# 風險調整收益
年化報酬率、最大回撤、Calmar比率

# 交易品質
Hit Rate、平均盈虧比、交易次數

# 統計顯著性
p-value、信心區間
```

---

## 💰 實戰執行模型

### 成本結構

```python
# 保守成本估計
手續費: 0.04% (Maker/Taker 平均)
滑點: 0.04-0.08% (依流動性調整)
總成本: 單邊 0.08-0.12%

# 流動性檢查
委託簿深度 < 閾值 → 禁止交易
點差 > 正常值 2倍 → 加重成本懲罰
```

### 無法成交處理

```python
# 極端情況
跳空: 用前一收盤價 ± ATR 估計衝擊
停牌: 延遲執行或取消信號
流動性枯竭: 自動縮減倉位或禁做
```

---

## 🛡️ 過擬合防護

### 參數限制

```python
# 固定粗粒度參數檔位
window_size: [40, 60, 80]
forward_periods: [8, 10, 15]
top_k_matches: [15, 20, 25]
confidence_threshold: [0.55, 0.60, 0.65]

# 過熱檢測
3+ 超參數同時調整 → 自動回退保守設定
```

### 穩健性檢查

```python
# 參數敏感度測試
win ±20%、K ±5、fwd ±3 的績效區間
仍在可接受範圍 → 參數可用
差異過大 → 可能過擬合
```

---

## 📊 系統整合與部署

### 與現有系統協作

```python
# 三層融合架構
Phase5 Lean: 75% 權重 (歷史優化參數)
Intelligent Trigger: 25% 權重 (實時技術狀態)
Phase1A: 智能協調與最終決策

# 更新頻率
日內微調: H4 信號更新
每日主要: D1 制度重評估
每週重構: W1 長期趨勢判斷
```

### 監控與預警

```python
# 系統健康檢查
相似度計算延遲 < 50ms
歷史數據完整性檢查
制度分類準確性監控

# 異常處理
數據缺失 → 自動降級到 D1/W1
計算錯誤 → 回退到保守參數
績效異常 → 觸發人工審查
```

---

## 🎯 實施建議

### 部署順序

1. **歷史數據庫建置** (2018+ 高品質數據)
2. **Walk-Forward 回測驗證** (至少 2 年 OOS)
3. **紙上交易驗證** (1-3 個月實盤模擬)
4. **小倉位實盤測試** (單筆風險 < 0.5%)
5. **逐步放大至目標倉位**

### 關鍵成功因素

- **數據品質**：穩定的歷史價量數據
- **執行紀律**：嚴格遵循風控規則
- **持續監控**：績效與參數穩定性
- **適應調整**：市場制度變化時的參數更新

### 風險控制

- **單筆風險**：0.5-2% 帳戶淨值
- **總體暴露**：同時持倉 < 20% 帳戶
- **回撤限制**：月度回撤 > 5% 時暫停交易
- **流動性要求**：僅交易前 20 大流動性幣種

---

## 📚 技術實現參考

### 核心算法

```python
# 詳見：phase5_enhanced_backtest_strategy.py
class LeanHistoricalMatcher:
    - build_features()      # 特徵提取
    - regime_detection()    # 制度分類
    - find_matches()        # 相似度搜索
    - vote_direction()      # 多框架投票
    - execution_filter()    # 執行過濾
```

### 驗證框架

```python
# Walk-Forward 回測引擎
class WalkForwardValidator:
    - rolling_window_split()  # 時間窗口切分
    - parameter_optimization() # 參數優化
    - out_of_sample_test()     # OOS 測試
    - performance_analysis()   # 績效分析
```

---

_最後更新：2025 年 8 月 18 日_
_版本：Phase5 Lean v1.0_
